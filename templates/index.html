<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet" />

    <title>âœï¸To DO List</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gaegu&display=swap');

        *{font-family: 'Gaegu', cursive;}

        body,
        h1,
        h2,
        h3,
        h4,
        p,
        div,
        a {
            margin: 0px;
            padding: 0px;
            text-decoration: none;
            font-weight: normal;
        }

        .box {
            margin: auto;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;

            width: 1200px;
        }

        /* ìƒë‹¨ ë°•ìŠ¤  */

        .topbox {
            /* background-color: rebeccapurple; */
            height: 150px;
            width: 90%;
            margin: auto;
            padding: 0px 40px;

            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .currentWeather {
            font-size: 28px;
        }

        .title {
            font-size: 35px;
            margin: auto;
        }

        .logoutbtn {
            height: 50px;
            width: 100px;
            background-color: lemonchiffon;
            border-radius: 40px;
            font-size: 15px;
            border: 1px solid gainsboro;
            color:gray;
            font-weight:600
        }


        /* íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ */
        .listBox {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;

            width: 95%;
            padding: 10px;

            background-color: white;
        }

        .todo_list {
            background-color: #8dcd52;

            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: left;

            margin-bottom: 10px;
            width: 90%;
            min-height: 50px;

            font-size: 30px;
            border-radius: 40px;
        }

        .todo_date {
            margin-right: 20px;
            font-size: 20px;
            margin: 0 20px;
            font-weight: bold;
        }

        .todo_list>h2 {
            font-size: 20px;
            margin-right: auto;
        }

        .todo_list>input {
            width: 20px;
            height: 20px;
            margin-left: auto;
            margin-right: 20px;
            outline: 0;
            cursor: pointer;
        }

        .todo_list>button {
            margin-right: 20px;
            cursor: pointer;
            font-size: 20px;
        }

        /* íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ì™„ë£Œì‹œ íƒ€ì´í‹€ê³¼ ë‚ ì§œì— ì·¨ì†Œì„  */
        .todo_list>.todo_date_done {
            margin-right: 20px;

            text-decoration: line-through;
            font-size: 15px;
            font-weight: bold;
        }

        .listBox>.todo_list>h2.done {
            text-decoration: line-through;
        }

        .myinput {
            background-color: lemonchiffon;
            width: 1100px;
            height: 130px;
            padding: 0px 40px;

            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;

            position: fixed;
            bottom: 40px;
            /* ë°‘ì—ì„œ 10px ìœ„ì— ê³ ì •í•˜ê¸° */
            left: calc(50% - 550px);
            /* position: fixed; ì¼ë•Œ ê°€ìš´ë°ë¡œ ì˜¤ê²ŒëŠ” ì„¤ì •
               (600pxëŠ” ctaì˜ width: 1200px; ë°˜ê°’) */

            border-radius: 40px;
            border: 1px solid gainsboro;
        }

        .date {
            width: 130px;
            height: 65px;
            font-size: 16px;
            text-align: center;
            padding-left: 10px;
            border-radius: 40px;
            color:gray;
            border: 1px solid gainsboro;
        }

        .inputList {
            width: 700px;
            height: 65px;
            font-size: 20px;
            padding-left: 20px;
            border-radius: 40px;
            color:gray;
            border: 1px solid gainsboro;
        }

        .myinput>button {
            width: 150px;
            height: 65px;
            font-size: 20px;
            border-radius: 40px;
            background-color: gainsboro;
            border: 1px solid gainsboro;
            color:gray;
            font-weight:800
        }
    </style>

    <script>
        $(document).ready(function () {
            show_todo();
            renderCurrentWeather()
            $('#listBox').empty();
        });

        // ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ì…ë ¥í•œ ì •ë³´
        let { email, nickname, password } = JSON.parse(
            localStorage.getItem('data')
        );
        console.log(email, nickname, password);


        // (GET) ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ íˆ¬ë‘ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¶œë ¥í•˜ê¸°
        function show_todo() {  // show_todo() í•¨ìˆ˜ëŠ” ì„œë²„ì— GET ìš”ì²­ì„ ë³´ë‚´ì„œ íˆ¬ë‘ ê°€ì ¸ì˜´
            $.ajax({  // AJAX = fetchì™€ ê°™ì€ ì—­í• 
                type: 'GET',
                url: '/todo',
                data: {},  // í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì— ì´ë ‡ê²Œ í‘œí˜„(GET ìš”ì²­ì´ê¸° ë•Œë¬¸ì— ë³´ë‚¼ ë°ì´í„° ì—†ìŒ / GETì€ ì½ì–´ì˜¨ë‹¤)
                success: function (response) {  // ìš”ì²­ì´ ì„±ê³µí•˜ë©´ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
                    let rows = response['todo_memos'];  // ì„œë²„ì—ì„œ ë°›ì€ ê°’ = "todo" ì»¬ë ‰ì…˜ì—ì„œ ëª¨ë“  ë¬¸ì„œë“¤
                                                        // AJAX ìš”ì²­ì„ ë³´ë‚´ë©´ ì„œë²„ëŠ” ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ”ë°, ì´ ë°ì´í„°ë¥¼ response ë³€ìˆ˜ì— ì €ì¥í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í™œìš©

                    for (let i = 0; i < rows.length; i++) {
                        const todo = rows[i].list;
                        const id = rows[i]._id;  // íˆ¬ë‘ì˜ ê³ ìœ  IDê°’
                        const done = rows[i].done;  // íˆ¬ë‘ì˜ ì™„ë£Œ ìƒíƒœ
                        const date = rows[i].date;

                        let temp_html = ``  // ì¶œë ¥í•  HTML ì½”ë“œë¥¼ ë‹´ì„ ë³€ìˆ˜
                        if (done === 0) {  // íˆ¬ë‘ê°€ ì™„ë£Œë˜ì§€ ì•Šì€ ìƒíƒœì¼ ë•Œ, ì™„ë£Œë˜ì§€ ì•Šì€ íˆ¬ë‘ì˜ HTML ì¶œë ¥
                            temp_html = `<div id="listBox" class="listBox">  
                                            <div class="todo_list">
                                                <div class="todo_date">${date}</div>
                                                <h2>${todo}</h2>
                                                <input class="todo_check" type="checkbox" id=${id} onclick="done_todo(event)">
                                                <button id=${id} onclick="delete_todo(event)" type="button" class="btn-close" aria-label="Close"></button>
                                            </div>
                                        </div>`
                        }
                        else {  // íˆ¬ë‘ê°€ ì™„ë£Œ ìƒíƒœì¼ ë•Œ, ì™„ë£Œëœ íˆ¬ë‘ì˜ HTML ì¶œë ¥
                            temp_html = `<div id="listBox" class="listBox">
                                            <div class="todo_list">
                                                <div class="todo_date_done">${date}</div>
                                                <h2 class="done">${todo}</h2>
                                                <input class="todo_check" type="checkbox" checked id=${id} onclick="cancel_todo(event)">
                                                <button id=${id} onclick="delete_todo(event)" type="button" class="btn-close" aria-label="Close"></button>
                                            </div>
                                        </div>`
                        }
                        $('#listBox').append(temp_html);
                    }
                }
            })
        };



        // (POST) ëª½ê³ DBì— íˆ¬ë‘ ë„£ê¸°
        function save_todo() {
            let date = $('#date').val()  // dateì— ì…ë ¥ëœ ê°’ì„ date ë³€ìˆ˜ì— ë„£ê¸°
            let list = $('#inputList').val()  // inputListì— ì…ë ¥ëœ ê°’ì„ List ë³€ìˆ˜ì— ë„£ê¸°
            
            let formData = new FormData(); // ì„œë²„ì— ì „ì†¡í•  ë°ì´í„°ë¥¼ ë‹´ê¸°
            formData.append("date_give", date);  // ë‚ ì§œë¥¼ 'date_give'ì— ë‹´ê¸°
            formData.append("list_give", list);  // íˆ¬ë‘ë¥¼ 'list_give'ì— ë‹´ê¸°
            
            fetch('/todo', { method: "POST", body: formData, }).then((response) => response.json()).then((data) => { // ì„œë²„ì— POST ìš”ì²­ ë³´ë‚´ê¸°
                alert(data["msg"]);  // ì„œë²„ë‹¨ returnê°’ì¸ jsonify({'msg': 'ì…ë ¥ ì™„ë£Œ!'})ê°€ ë“¤ì–´ì™€ì„œ ì¶œë ¥ë¨
                window.location.reload();
            });
        }




        // (GET) í´ë¼ì´ì–¸íŠ¸ ì¶œë ¥ í›„ > (POST) ì™„ë£Œ íˆ¬ë‘ ì²˜ë¦¬
        function done_todo(event) {  // eventëŠ” 'í´ë¦­' ê°™ì€ ë™ì‘ì— ëŒ€í•œ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìŒ
            const id = event.target.getAttribute('id');  // event.target : í´ë¦­í•œ ìš”ì†Œ(ì²´í¬ë°•ìŠ¤ onclick=done_todo)ë¥¼ ë§í•˜ë©° ì²´í¬ë°•ìŠ¤ onclickì˜ ì•„ì´ë””ê°’(=íˆ¬ë‘ì˜ ê³ ìœ  IDê°’) ê°€ì ¸ì˜¤ê¸°
            $.ajax({  // ì„œë²„ë¡œ í•  ì¼ ì™„ë£Œ ìš”ì²­ì„ ë³´ë‚´ê¸° ìœ„í•´ AJAX ìš”ì²­ ì „ì†¡(fetchì™€ ê°™ì€ ì—­í• )
                type: "POST",
                url: "/todo/done",
                data: { id_give: id },  // ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„°: íˆ¬ë‘ì˜ id
                success: function (response) {  // ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆì„ ë•Œ ì‹¤í–‰í•  í•¨ìˆ˜
                    alert(response["msg"])  // ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µ ë°ì´í„° ì¤‘ "msg"ë¼ëŠ” ì´ë¦„ì˜ ê°’ì„ íŒì—… ì°½ìœ¼ë¡œ í‘œì‹œ
                    // responseëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì„œë²„ë¡œë¶€í„° ë°›ì€ ì‘ë‹µ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë³€ìˆ˜
                    window.location.reload()
                }
            });
        }



        // (GET) í´ë¼ì´ì–¸íŠ¸ ì¶œë ¥ í›„ > (POST) ì™„ë£Œì·¨ì†Œ íˆ¬ë‘ ì²˜ë¦¬
        function cancel_todo(event) {  // eventëŠ” 'í´ë¦­' ê°™ì€ ë™ì‘ì— ëŒ€í•œ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìŒ
            const id = event.target.getAttribute('id');  // event.target : í´ë¦­í•œ ìš”ì†Œ(ì²´í¬ë°•ìŠ¤ onclick=cancel_todo)ë¥¼ ë§í•˜ë©° ì²´í¬ë°•ìŠ¤ onclickì˜ ì•„ì´ë””ê°’(=íˆ¬ë‘ì˜ ê³ ìœ  IDê°’) ê°€ì ¸ì˜¤ê¸°
            $.ajax({
                type: 'POST',
                url: '/todo/cancel',
                data: { id_give: id },  // ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„°: íˆ¬ë‘ì˜ id
                success: function (response) {  // ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆì„ ë•Œ ì‹¤í–‰í•  í•¨ìˆ˜
                    alert(response['msg']);  // ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µ ë°ì´í„° ì¤‘ "msg"ë¼ëŠ” ì´ë¦„ì˜ ê°’ì„ íŒì—… ì°½ìœ¼ë¡œ í‘œì‹œ
                    // responseëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì„œë²„ë¡œë¶€í„° ë°›ì€ ì‘ë‹µ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë³€ìˆ˜
                    window.location.reload();
                },
            });
        }



        // (GET) í´ë¼ì´ì–¸íŠ¸ ì¶œë ¥ í›„ > (POST) ì‚­ì œ íˆ¬ë‘ ì²˜ë¦¬
        function delete_todo(event) {
            const id = event.target.getAttribute('id');  // event.target : í´ë¦­í•œ ìš”ì†Œ(ë²„íŠ¼ onclick=delete_todo)ë¥¼ ë§í•˜ë©° ë²„íŠ¼ onclickì˜ ì•„ì´ë””ê°’(=íˆ¬ë‘ì˜ ê³ ìœ  IDê°’) ê°€ì ¸ì˜¤ê¸°
            $.ajax({
                type: 'POST',
                url: '/todo/delete',
                data: { id_give: id },
                success: function (response) {
                    alert(response['msg']);
                    window.location.reload();
                },
            });
        }

        function renderCurrentWeather() {
            let url = `http://spartacodingclub.shop/sparta_api/weather/seoul`  // https://goweather.herokuapp.com/weather/seoul > ì—°ê²°ì´ ì•ˆë ë•Œë„ ìˆì–´ì„œ ì„œìš¸ì˜ ë‚ ì”¨ë¡œ ê°€ì ¸ì˜´
            fetch(url).then(res => res.json()).then((data) => {
                let Weather = data['temp'].toFixed(1)  // ì†Œìˆ˜ì  í•œìë¦¬ê¹Œì§€ ê°€ì ¸ì˜´(ë°˜ì˜¬ë¦¼ë¨)
                $('#currentWeather').text(Weather)
            })
        }

        function logout() {
            window.location.href = 'http://127.0.0.1:5500/templates/login.html'  // 127.0.0.1(IP):5500(port)ë²ˆí˜¸            
            // window.location.href = 'https://www.google.co.kr/?hl=ko'  // ì„œë²„ ì—°ê²° í›„ êµ¬ê¸€ë¡œ ì´ë™
            // window.location.href = 'login.html'  // ì„œë²„ ì—°ê²° ì „ í˜ì´ì§€ë§Œ ì—°ê²°

            // window.location.href = 'login.html'  // ì•ˆë¨
            // window.location.href = 'templates/login.html'  // ì•ˆë¨
            // window.location.href = 'http://login.html'  // ì•ˆë¨
            // window.location.href = 'http://templates/login.html'  // ì•ˆë¨
            // window.location.href = 'http://127.0.0.1:5001/login.html'  // ì•ˆë¨
        }   
    </script>
</head>


<body>
    <div class="box">
        <!-- ë‚ ì”¨, ì œëª©, ë¡œê·¸ì•„ì›ƒ -->
        <div class="topbox">
            <div id="currentWeather" class="currentWeather"></div>
            <div class="title">ğŸ¸ {íˆ¬ë‘ë¦¬}ë‹˜ì˜ TO-DO-LIğŸ¸</div>
            <div>
                <button class="logoutbtn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- ì…ë ¥ëœ ë¦¬ìŠ¤íŠ¸ë“¤(ë‚ ì§œ, ë‚´ìš©, ì²´í¬) -->
        <div id="listBox" class="listBox">
            <div class="todo_list">
                <div class="todo_date">ë‚ ì§œ</div>
                <h3>ì›¹ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ ì œì¶œí•˜ê¸°</h3>
                <button>ì²´í¬</button>
            </div>
        </div>

        <!-- ë‚ ì§œì„ íƒ, ì¸í’‹(ë‚´ìš©ì‘ì„±), ê¸°ë¡í•˜ê¸°ë²„íŠ¼ -->
        <div class="myinput">
            <input id="date" class="date" type="date">
            <input id="inputList" class="inputList" type="text" placeholder="To Do Listë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”" />
            <button onclick="save_todo()">ê¸°ë¡í•˜ê¸°</button>
        </div>
    </div>